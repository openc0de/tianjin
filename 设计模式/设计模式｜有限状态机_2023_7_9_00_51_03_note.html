<!DOCTYPE html> <html lang=zh-cn style=--olcb-folder-code-block-max-height:80vh;--cnb-code-bg:rgb(245,245,245);--cnb-code-font-size:12px;--cnb-code-color:rgb(68,68,68) class><!--
 Page saved with SingleFile 
 url: https://www.cnblogs.com/autosar/archive/2012/06/22/2558604.html 
 saved date: Sun Jul 09 2023 00:51:03 GMT+0800 (中国标准时间) 
 info: 嵌入式设计模式：有限状态自动机的C语言实现 - chrihop - 博客园_2023/7/9_00_51_03_note.html
--><meta charset=utf-8>
<meta name=viewport content="width=device-width, initial-scale=1.0">
<meta name=referrer content=origin-when-cross-origin>
<meta name=description content="状态机模式是一种行为模式，在《设计模式》这本书中对其有详细的描述，通过多态实现不同状态的调转行为的确是一种很好的方法，只可惜在嵌入式环境下，有时只能写纯C代码，并且还需要考虑代码的重入和多任务请求跳转等情形，因此实现起来着实需要一番考虑。 近日在看了一个开源系统时，看到了一个状态机的实现，也学着写了">
<meta property=og:description content="状态机模式是一种行为模式，在《设计模式》这本书中对其有详细的描述，通过多态实现不同状态的调转行为的确是一种很好的方法，只可惜在嵌入式环境下，有时只能写纯C代码，并且还需要考虑代码的重入和多任务请求跳转等情形，因此实现起来着实需要一番考虑。 近日在看了一个开源系统时，看到了一个状态机的实现，也学着写了">
<meta http-equiv=Cache-Control content=no-transform>
<meta http-equiv=Cache-Control content=no-siteapp>
<meta http-equiv=X-UA-Compatible content="IE=edge">
<title>嵌入式设计模式：有限状态自动机的C语言实现 - chrihop - 博客园</title>
<style>.navbar a:hover{color:#666;text-decoration:underline}.navbar a:link,.navbar a:active,.navbar a:visited{color:#666;text-decoration:none}@media screen and (min-width:769px){.dropdown:hover .dropdown-menu.quick-search-menu{max-height:0}.dropdown:hover .dropdown-menu,.dropdown:focus-within .dropdown-menu.quick-search-menu{max-height:1000px;z-index:1000}.dropdown:focus-within .focus-hidden{display:none}}.dropdown>.dropdown-menu{-webkit-transition:all .5s ease,max-height .5s ease;-o-transition:all .5s ease,max-height .5s ease;display:block;-webkit-box-shadow:2px 2px 13px 0 rgba(212,212,212,.5)}.dropdown>.dropdown-menu>*:not(:first-child){margin-top:10px}.dropdown>.dropdown-menu>*:first-child{margin-top:10px}.dropdown>.dropdown-menu>*:last-child{margin-bottom:10px}.navbar{display:flex;flex-direction:column;align-items:center;background-color:#fff;padding-top:5px;padding-bottom:5px}.navbar>nav{display:flex;font-size:15px;color:#666;flex-direction:row;flex-wrap:nowrap;align-items:center;justify-content:space-between;width:100%}.navbar>nav .navbar-branding{width:140px;flex-shrink:0;margin-right:5px}.navbar>nav .navbar-branding img{display:block;max-height:28px;height:28px;margin-left:10px}.navbar>nav .navbar-left>*:not(:first-child){margin-left:31px}.navbar>nav .navbar-right>*:not(:first-child),.navbar>nav #navbar_login_status>*:not(:first-child){margin-left:24px}.navbar>nav #navbar_login_status{min-width:120px}.navbar>nav .navbar-list{display:flex;flex-direction:row;align-items:center;flex-wrap:nowrap;list-style:none;white-space:nowrap;transition:width .5s ease}.navbar>nav .navbar-search{padding-left:20px;padding-right:20px;display:flex;flex-direction:row;align-items:center;border-radius:6px;background-color:#f4f4f4;height:32px}.navbar>nav .navbar-search:focus-within{border-bottom-left-radius:0;border-bottom-right-radius:0}.navbar>nav .navbar-search img{width:19px;height:19px}.navbar>nav .navbar-search>input{border:none;outline:none;background:none;width:170px;font-size:inherit}.navbar>nav .navbar-search>button{background:none;border:none;cursor:pointer}.navbar>nav .navbar-search>input::-webkit-input-placeholder{color:#afafaf;opacity:1}.navbar>nav .navbar-search>input::placeholder{color:#afafaf;opacity:1}.navbar>nav .navbar-icon-wrapper{position:relative}.navbar-right .dropdown-menu{right:0}.dropdown{display:-ms-inline-flexbox;position:relative}@media screen and (min-width:769px){.dropdown:hover .dropdown-menu,.dropdown:focus-within .dropdown-menu,.dropdown:active .dropdown-menu{max-height:1000px;z-index:1000}}.dropdown>.dropdown-menu.quick-search-menu{left:0;padding-left:0;padding-right:0;border-top-left-radius:0;border-top-right-radius:0}.dropdown>.dropdown-menu.quick-search-menu>*{display:flex;align-items:center;justify-content:space-between}.dropdown>.dropdown-menu.quick-search-menu .search-area{font-size:11px;padding:2px 4px;border-radius:5px;border-style:solid;border-width:1px;border-color:#999}.dropdown>.dropdown-menu.quick-search-menu .keyword-wrapper{display:flex;align-items:center;min-width:0}.dropdown>.dropdown-menu.quick-search-menu .keyword-wrapper img{width:1em;height:1em}.dropdown>.dropdown-menu.quick-search-menu .keyword{min-width:1px;flex-grow:1;overflow-x:hidden;text-overflow:ellipsis;white-space:nowrap;padding:0 10px}.dropdown>.dropdown-menu.quick-search-menu>*:first-child{margin-top:0}.dropdown>.dropdown-menu.quick-search-menu>*:not(:first-child){margin-top:0}.dropdown>.dropdown-menu.quick-search-menu>*:last-child{margin-bottom:0;padding-bottom:10px}.dropdown>.dropdown-menu.quick-search-menu>*{margin-top:0;margin-bottom:0;padding:5px 10px}.quick-search-menu>*:hover{background-color:rgba(0,0,0,.01);cursor:pointer}.quick-search-menu>.active{background-color:rgba(0,0,0,.05)}.dropdown>.dropdown-menu{-webkit-transition:all .5s ease,max-height .5s ease;-o-transition:all .5s ease,max-height .5s ease;transition:all .5s ease,max-height .5s ease;max-height:0;overflow:hidden;position:absolute;top:100%;border-radius:5px;min-width:5em;-webkit-box-shadow:2px 2px 13px 0 rgba(212,212,212,.5);box-shadow:2px 2px 13px 0 rgba(212,212,212,.5);background-color:#f9f9f9}.dropdown>.dropdown-menu>*:not(:first-child){margin-top:10px}.dropdown>.dropdown-menu>*:first-child{margin-top:10px}.dropdown>.dropdown-menu>*:last-child{margin-bottom:10px}.syntaxhighlighter div,.syntaxhighlighter code,.syntaxhighlighter table,.syntaxhighlighter table td,.syntaxhighlighter table tr,.syntaxhighlighter table tbody{-moz-border-radius:0 0 0 0!important;-webkit-border-radius:0 0 0 0!important;background:none!important;border:0!important;bottom:auto!important;float:none!important;height:auto!important;left:auto!important;line-height:1.1em!important;margin:0!important;outline:0!important;overflow:visible!important;padding:0!important;position:static!important;right:auto!important;text-align:left!important;top:auto!important;vertical-align:baseline!important;width:auto!important;box-sizing:content-box!important;font-family:"Consolas","Bitstream Vera Sans Mono","Courier New",Courier,monospace!important;font-weight:normal!important;font-style:normal!important;font-size:1em!important;min-height:inherit!important;min-height:auto!important}.syntaxhighlighter{width:100%!important;margin:1em 0 1em 0!important;position:relative!important;overflow:auto!important;font-size:1em!important}.syntaxhighlighter .bold{font-weight:bold!important}.syntaxhighlighter .line{white-space:pre!important}.syntaxhighlighter table{width:100%!important}.syntaxhighlighter table td.code{width:100%!important}.syntaxhighlighter table td.code .container{position:relative!important;z-index:1}.syntaxhighlighter table td.gutter .line{text-align:right!important;padding:0 .5em 0 1em!important}.syntaxhighlighter table td.code .line{padding:0 1em!important}.syntaxhighlighter{background-color:#fff!important}.syntaxhighlighter .line.alt1{background-color:#fff!important}.syntaxhighlighter .gutter{color:#afafaf!important}.syntaxhighlighter .gutter .line{border-right:3px solid #6ce26c!important}.syntaxhighlighter .plain{color:#000!important}.syntaxhighlighter .comments{color:#008200!important}.syntaxhighlighter .string{color:#00f!important}.syntaxhighlighter .keyword{color:#069!important}.syntaxhighlighter .preprocessor{color:#808080!important}.syntaxhighlighter .functions{color:#ff1493!important}.syntaxhighlighter .color1{color:#808080!important}.syntaxhighlighter .keyword{font-weight:bold!important}.syntaxhighlighter code{white-space:pre-wrap;white-space:-moz-pre-wrap!important;white-space:-o-pre-wrap}.syntaxhighlighter .line{white-space:normal!important;line-height:1.8em!important}.syntaxhighlighter code{line-height:1.8em!important}.syntaxhighlighter table td.code{width:auto!important}.syntaxhighlighter .line.alt2{background-color:#f4f4f4!important}.syntaxhighlighter .gutter{width:35px!important}.syntaxhighlighter .gutter .line{border-right:2px solid #6ce26c!important}.syntaxhighlighter table td.gutter .line{padding:0 .5em 0 .5em!important;text-align:right!important}.syntaxhighlighter .keyword{font-weight:normal!important;color:#00f!important}.syntaxhighlighter div,.syntaxhighlighter code,.syntaxhighlighter table,.syntaxhighlighter table td,.syntaxhighlighter table tr,.syntaxhighlighter table tbody{font-size:12px!important}body{tab-size:4}input[type=button]{-webkit-appearance:button}img{border:0;max-width:100%;height:auto}#blog_post_info_block{margin-top:20px}.cnblogs-markdown :not(pre,div,td)>code,.blogpost-body :not(pre,div,td)>code{font-family:"Courier New",sans-serif;font-size:12px;padding:0 5px;line-height:1.8;margin:0 3px;display:inline-block;overflow-x:auto;vertical-align:middle;border-radius:3px;background-color:#f6f6f6;color:#e83e8c}.div_my_zzk{margin-top:5px;margin-bottom:5px}.input_my_zzk{width:100px;vertical-align:middle;height:20px}input.btn_my_zzk{vertical-align:middle;height:22px;font-size:12px;padding-left:5px;padding-right:5px}#author_profile{float:left;width:280px;margin-top:0;margin-bottom:10px;color:#000;margin-left:0;font-size:12px}#author_profile a:hover{text-decoration:underline}.author_avatar{vertical-align:top;float:left;margin-right:5px;padding-top:5px;padding-left:2px;border:0}.author_profile_info{float:left;line-height:18px}#div_digg{float:right;margin-bottom:10px;margin-right:30px;font-size:12px;width:125px;text-align:center;margin-top:10px}.diggit{float:left;width:46px;height:52px;background:url(data:image/gif;base64,R0lGODlhLgA0AMQAAP/00P/22vfqt/b29v/11f/45P/56P/34PjtwfXlqf/55v/11//00v/44vnwyfn5+f/22Pbnrf/21vny0Pn00//33vDw8P/12KioqP/10ufm61B1uv/33f/33P////H4+iH5BAAAAAAALAAAAAAuADQAAAX/oJeMZGmeaJqKQOu+cCzPcxLJmZvlcM4DPlosE4kwMsfdLrlEIo8MZvRJjTKbxaZyy+16v94iYUwum8/odDlDjgjU8Lh8LBAs7mQ8YTHmS/aAfHyBeHeCg3l1dxAQFwsXkBeMjJILEJaNko2bk4+Pl4x3knUBpaanqKmqq6sCCAEdsR2ws6mytbSwprGns766HQgIHByxxR3FxMi3y8nIycTO0MqywtTH0Mu30s/PytLRt9bYxt3Hstzf4eDUsePlzc7bzebr8e3Bw+Tx2uj06t/unct3rVzAeeC8pQtXTR+8bAP/1Qs4beA7bRCZLVT4j6E7hxjNaezIkZ1FkOQO//pLGG0hvosp5a3k17LjSwQVcurcybOnz58/ETg4QLSo0aNIkypV6sBBg6dPC0CdWkBqg6pTs1q1qpWrgwlVw4odS7as2bMTJihYy7at27dw48adQMGA3bt48+rdy5cv3b6AAwu2S8EDhcOIEytezLhxYw+QI0ueTLmy5cuYM2veDPmD58+gQ4seTbq0htIPBqguzbq159OjH2jQgEHDANe4RcMWPUCDBwsYHuQe/pr0bA8PMNwmnnt36N6/lYve8Jk69enVdYdO3ds38OWgr4sPv6G8+fOfndPGwB5DdPAf0J8vjz2+ds8eMFigPEB/aOvjVTfffOl91t96+0X2HYB58REYHmu7JWfZgp7RZ9+FDw4I2m79teebgrVVeGGAD5ZYoGcSVjbBBvCJ52CDDb4Y4Xq1SQYcBSWSaN91Ioa222+0WSDkkBiwmGOPJmJ4ooHsbVDkkw4I6CJ62cV4H2gPFHDABVsWAB9zEIIppnFjlrnhbGimqeaabLbp5mwhAAA7)no-repeat;text-align:center;cursor:pointer;margin-top:2px;padding-top:5px}.diggnum{font-size:14px;color:#075db3;font-family:Verdana}.buryit{float:right;margin-left:20px;width:46px;height:52px;background:url(data:image/gif;base64,R0lGODlhLgA0AMQAAP////39/fn5+fj4+Pb29vX19fPz8/Ly8vHx8fDw8O/v7+7u7u3t7ezs7Ovr6+rq6ujo6Ofn5+bm5uXl5ePj4+Li4uHh4dzc3NfX19HR0c/Pz6qqqqioqKenp4WFhYODgyH5BAQUAP8ALAAAAAAuADQAAAX/IKCNZGmeaJqKUeu+cCzP80jfeN5mGeT/wKBwSCTyisik0sd7OJ/QqHRKpWYw1ax268RgHGDuFkwuO6Res3rNbre9jbh8Tq/b73fMpcHo+xl2f3iDdRcXC4iJiol/jY2LkIh/hpGQjpcMlYuTh5qMmI+ekn6UogugoaKcpqeofqyrpq6vsqSdqrOZtX2luLOwtsC/uwy9nrm6vsW3x7nCy6zR0ogXFgrX2Nna29zd3RYWCeLj5OXm5+jo4Ajs7e7v8PHy8hQUB/f4+fr7/P399QYCChxIsKDBgwcBIlzIsKGBCQAmSJxIsaLFixgxAtjIsaPHjyBDihxJsqTJjQVS8KpcybKly5cwIcCcSbOmSpk2c+pMiZOlAHYOFDhAQGBnzp4rN2z4wIEp0wpGayIFkOABB3MdPBh4+aHrB5pfb64UYJUDBwgdFXCYsNJr2LZu265EKoBDSAoftqp8O5MvX6QFzJpFyzHBWbhuu+5NmVgxz7EcAoA0XHQxS78FMItdedZsgo4HOFRmnNmy3NKoH6sEwAHBxwEcFlxOzZc06b8sIwg2S5WD3tNfa5cOG3xuSwEECPjoPdq2c8uaVb9ES3l25uKmoxcAPBdt3ebB/Tpu6dV4TAChBUSVClOADw4Smq93yX1scvnzWy7Zzz9ICAA7)no-repeat;text-align:center;cursor:pointer;margin-top:2px;padding-top:5px}.burynum{font-size:14px;color:#075db3;font-family:Verdana}.diggword{margin-top:5px;margin-left:0;font-size:12px;color:#808080}#profile_block{margin-top:5px;line-height:1.5;text-align:left}#post_next_prev{line-height:1.8;font-size:12px}#post_next_prev a.p_n_p_prefix:link{text-decoration:none}#post_next_prev a.p_n_p_prefix:hover{text-decoration:underline}.under-post-card{margin-top:10px;line-height:1.5}#green_channel{padding:10px 0;margin-bottom:10px;margin-top:10px;border:#c0c0c0 1px dashed;font-size:12px;width:350px;text-align:center}#green_channel a{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAkCAYAAABIdFAMAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAHhJREFUeNo8zjsOxCAMBFB/KEAUFFR0Cbng3nQPw68ArZdAlOZppPFIBhH5EAB8b+Tlt9MYQ6i1BuqFaq1CKSVcxZ2Acs6406KUgpt5/LCKuVgz5BDCSb13ZO99ZOdcZGvt4mJjzMVKqcha68iIePB86GAiOv8CDADlIUQBs7MD3wAAAABJRU5ErkJggg%3D%3D)repeat-x;display:inline-block;padding:3px 8px;color:#fff;text-decoration:none;font-weight:bold;cursor:pointer;margin-right:10px;-moz-border-radius:5px;-webkit-border-radius:10px;-moz-box-shadow:0 1px 3px rgba(0,0,0,.5);-webkit-box-shadow:0 1px 3px rgba(0,0,0,.5);text-shadow:0-1px 1px rgba(0,0,0,.25);vertical-align:middle}#green_channel a:hover{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAyCAYAAACd+7GKAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAClJREFUeNpi/v//vwMTAwPDfzjBgMpFI/7hFSOT9Y8qRuF3JLoHAQIMAHYtMmRA+CugAAAAAElFTkSuQmCC)}#green_channel #green_channel_digg{background-color:#2daebf}#green_channel #green_channel_follow{background-color:#e33100}#green_channel #green_channel_favorite{background-color:#ffb515}#green_channel #green_channel_weibo img{vertical-align:middle;border:none;margin-left:5px;box-shadow:none}#green_channel #green_channel_weibo,#green_channel #green_channel_wechat{background:none;padding:3px 2px;-moz-border-radius:none;-webkit-border-radius:none;-moz-box-shadow:none;-webkit-box-shadow:none;text-shadow:none}#green_channel #green_channel_wechat img{width:24px;height:24px;border:medium none;box-shadow:none;margin-left:5px;vertical-align:middle}#cnblogs_post_body{margin-bottom:20px}#cnblogs_post_body table{border-collapse:collapse;word-break:break-word}#cnblogs_post_body .table-wrapper{display:block;overflow-x:auto}.blogpost-body td,.blogpost-body td{border:1px solid #c0c0c0;border-collapse:collapse;padding:8px 14px;min-width:50px}#cnblogs_post_body img{max-width:100%!important;height:auto}.ad_text_commentbox{margin-top:5px;margin-bottom:5px}#opt_under_post{line-height:1.8}.recent_comment_author{text-align:right;margin-right:4px}#HistoryToday{max-width:600px;text-overflow:ellipsis;white-space:nowrap;overflow:hidden}.CalTitle{width:100%}.recent_comment_body{word-wrap:break-word}#cnblogs_post_body{word-break:break-word}#cnblogs_post_body p{margin:10px auto}#cnblogs_post_body p{text-indent:0}#div_digg .diggnum{line-height:1.5em!important}#div_digg .burynum{line-height:1.5em!important}#green_channel a:link,#green_channel a:visited,#green_channel a:active{color:#fff!important;border:none!important}.vertical-middle>*{vertical-align:middle}#blog-news{overflow:hidden}.syntaxhighlighter td{min-width:auto!important}.category-item-link{word-break:break-word}#cnblogs_c1{width:300px;height:250px}.sidebar-card-title-a,a.sidebar-card-title-a:link,a.sidebar-card-title-a:visited{font-style:inherit!important;font-weight:inherit!important;font-size:inherit!important;color:inherit!important}.sidebar-category-item-count{font-size:11px;font-weight:normal}@keyframes fadeIn{0%{opacity:0}100%{opacity:var(--cnb-code-toolbar-initial-opacity)}}.login_tips{background-image:url(data:image/gif;base64,R0lGODlhEAAQAOZbAOny/v3+/lqIuT1wIOLu/lOMKKnB2omqzbTJ34+8Z9vq/c7c6tfo/ZSwhJOx0WyVwJGugWCJSbLSlff5/Pv8/efu9Y26ZDdrGUFzJXCYwuDt/vP3+uvx94usztrk793s/m6XwYe5YN/s/qO92Iu6YnCWXpeyiOnv9tXm/bHTkKa9mZ241dDj/dzm8Ex7Mejx/lePLd3r/vn7/NHk/eXw/tDk/dPm/dTm/dzq/d7s/tbn/WaOT3ugx2+XwuTv/o+7arbUnNnp/dDmurHFq9zr/X2iyF+Mu+bw/pm21Obx/oe6YFyKuvD2/oWny7HWktrp/Yy8ZYKjk+Pv/uHu/r7Q4z9xItHk/LTUlYGrYViHuP///////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAAFsALAAAAAAQABAAAAemgFuCg4SFhoeGGw5LWY2OWU0VhB0GFFqXmFoIGRSCEwIBTABJPlM5CjhaPC2CHA9aL0dSGh8KDChaBwutrzQEGjFPDDczubtbnwEAIkRBOjY1VlpFHoOUAZgELACaGTKDigKNK5dDJTsRKog9FVFYV0I/MBCGI0hGESlOWlAJA4UnQFDZ4gIIJgkXEG2pQkKJlhD+FJooYEGChQL0FDbAcAFDgy2BAAA7);background-repeat:no-repeat;margin-top:10px;padding:0 0 10px 25px;font-weight:400}.login_tips a{text-decoration:underline!important}.clear{clear:both}#comment_nav{text-align:right}#comment_nav a{padding-left:10px}:root{--highlighted-line-bg:#d1e3c9;--highlighted-line-bg-dark:#264b33}:root{--cnblogs-current-collection-bg-color:rgba(245,245,245,.98);--cnblogs-current-collection-highlight-color:rgba(255,255,255,.9);--cnblogs-current-collection-hover-color:rgba(255,255,255,.7);--cnblogs-current-collection-active-color:rgba(255,255,255,.8);--cnblogs-current-collection-color:#000}@keyframes collapse{from{max-height:80vh;max-height:80vh;max-height:var(--olcb-folder-code-block-scroll-height,80vh)}to{max-height:80vh;max-height:80vh;max-height:var(--olcb-folder-code-block-max-height,80vh)}}@keyframes expand{from{max-height:80vh;max-height:80vh;max-height:var(--olcb-folder-code-block-max-height,80vh);overflow-y:hidden}to{max-height:"";max-height:"";max-height:var(--olcb-folder-code-block-scroll-height,"");overflow-y:hidden}}@keyframes modal-open{0%{height:0;opacity:0}95%{height:505px}100%{height:auto;opacity:1}}:root{--cnblogs-toc-bg-color:rgba(245,245,245,.98);--cnblogs-toc-highlight-color:rgba(255,255,255,.9);--cnblogs-toc-color:#000}body{min-height:100vh}@keyframes wb-fade-in{0%{opacity:0}to{opacity:.85}}.dropdown-menu{z-index:1000;padding:0;float:left;margin:2px 0 0;list-style:none;text-shadow:none}/*!
 * ui-dialog.css
 * Date: 2014-07-03
 * https://github.com/aui/artDialog
 * (c) 2009-2014 TangBin, http://www.planeArt.cn
 *
 * This is licensed under the GNU LGPL, version 2.1 or later.
 * For details, see: http://www.gnu.org/licenses/lgpl-2.1.html
 */@-webkit-keyframes ui-dialog-loading{0%{-webkit-transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg)}}@keyframes ui-dialog-loading{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}a:link,a:active{color:#56b6e9}a:visited{color:#56b6e9}a:hover{color:#94d0f1}body{background-image:url(data:image/gif;base64,R0lGODlhGAAYAIAAAMbo/P///yH5BAQUAP8ALAAAAAAYABgAAAI5jA2HGqm+HoOx2jalPhTzvFndCDJf6J0XGbKqWK6oC8+xSaf1q+s5/YsFW7dc8cgbymxJ5LIJjRoKADs=);margin:0;padding:0;font-family:"PingFang SC","Microsoft YaHei","Helvetica Neue","Helvetica","Arial",sans-serif;font-size:12px;word-wrap:break-word}.navbar{border-bottom:1px dotted #8b8d72;padding-left:20px;padding-right:20px}.navbar>nav .navbar-list{margin:0;padding:0;font-size:14px}.header{height:85px;background-color:#fff;border-bottom:1px dotted #8b8d72;padding-left:264px;padding-top:15px}a.headermaintitle{font-size:18px;font-weight:bold;text-decoration:none}#leftcontent{position:absolute;left:20px;width:220px;background-color:#fff;border:1px dotted #8b8d72;border-top:8px solid #8b8d72;border-bottom:8px solid #8b8d72}.has-navbar #leftcontent{top:62px}#leftcontentcontainer{padding:10px}#centercontent{padding-top:25px;padding-right:20px;padding-left:260px}#mytopmenu{color:#8b8d72;border:1px dotted #8b8d72;border-top:0;background-color:#fff;padding:8px;padding-left:10px;padding-right:10px;margin-top:0;margin-right:20px;margin-left:260px;text-align:right}#mylinks{position:absolute;padding:8px;padding-left:12px;padding-right:12px;left:260px}.footer{color:#8b8d72;padding:12px;padding-left:10px;margin-top:0;margin-right:20px;margin-left:260px;text-align:center;line-height:20px}.news{font-family:Verdana;font-weight:bold}.newsItem{margin-top:2px;margin-bottom:20px}.post{border:1px dotted #8b8d72;background-color:#fff;padding:20px;color:#232323;font-size:14px;line-height:1.8}.postTitle{font-size:14px;font-weight:bold;margin-bottom:10px}.postTitle2{text-decoration:none;font-size:14px}.postDesc{color:#4b8d32;margin-top:10px}.comments{border-top:0;background-color:#fff;padding-left:22px;padding-top:0}.catListTitle{font-family:Verdana;font-size:12px;margin-bottom:2px}.catList{list-style:none;border-top:0;margin:0;padding:0;margin-bottom:20px}ul{list-style:none;margin:0;padding-left:5px;margin-left:5px;margin-bottom:10px;font-size:12px}.Cal{width:200px;font-family:Arial;font-size:12px;margin-top:10px;margin-bottom:10px;height:180px}.CalTitle{background-color:#fff;font-family:Arial;font-size:13px;margin-left:0;padding:0;height:100%;font-weight:bold}.CalOtherMonthDay{color:#808080}.CalNextPrev{color:#fff}.CalDayHeader{background-color:#efefef;font-weight:bold}.CalWeekendDay{background-color:#efefef}.CalTodayDay{background-color:#ddd}.news{font-size:12px}</style>
<style media="only screen and (max-width: 767px)">body{font-size:14px!important;-webkit-text-size-adjust:none}.forpc{display:none!important}#blog_nav_rss{display:none!important}#blog_nav_rss_image{display:none!important}#blog_nav_newpost{display:none!important}.blogpost-body img{max-width:300px!important;height:auto}#green_channel{width:100%}#sidebar_search_box input[type=text]{width:260px}#cnblogs_post_body table{display:block;overflow-x:scroll;-webkit-overflow-scrolling:regular;max-height:800px}#cnblogs_post_body table::-webkit-scrollbar:horizontal{height:12px}#cnblogs_post_body table::-webkit-scrollbar-track{-webkit-box-shadow:inset 0 0 6px rgba(0,0,0,.3);border-radius:10px;background-color:#f5f5f5}#cnblogs_post_body table::-webkit-scrollbar{width:12px;background-color:#f5f5f5}#cnblogs_post_body table::-webkit-scrollbar-thumb{border-radius:10px;-webkit-box-shadow:inset 0 0 6px rgba(0,0,0,.3);background-color:#555}#cnblogs_c1{text-align:center;margin:10px auto 0 auto}#cnblogs_c1{width:300px}.commentform{margin-left:10px}.navbar{display:none}.cnblogs-markdown :not(pre,div,td)>code,.blogpost-body :not(pre,div,td)>code{white-space:pre-wrap}#leftcontent{position:static;width:auto;margin:0 10px}#main{display:flex;flex-flow:column}#leftcontent{order:2}#centercontent{order:1;padding:10px}.header{padding-left:10px}#mylinks{left:0;padding-left:20px}#mytopmenu{margin:0 10px;padding-top:30px}</style>
<link type=application/rss+xml rel=alternate href=https://www.cnblogs.com/autosar/rss>
<link type=application/rsd+xml rel=EditURI href=https://www.cnblogs.com/autosar/rsd.xml>
<link type=application/wlwmanifest+xml rel=wlwmanifest href=https://www.cnblogs.com/autosar/wlwmanifest.xml>
<style data-id=immersive-translate-input-injected-css>*:before,*:after{pointer-events:none!important}@keyframes immersiveTranslateShadowRolling{0%{box-shadow:0px 0 rgba(255,255,255,0),0px 0 rgba(255,255,255,0),0px 0 rgba(255,255,255,0),0px 0 rgba(255,255,255,0)}12%{box-shadow:100px 0 var(--loading-color),0px 0 rgba(255,255,255,0),0px 0 rgba(255,255,255,0),0px 0 rgba(255,255,255,0)}25%{box-shadow:110px 0 var(--loading-color),100px 0 var(--loading-color),0px 0 rgba(255,255,255,0),0px 0 rgba(255,255,255,0)}36%{box-shadow:120px 0 var(--loading-color),110px 0 var(--loading-color),100px 0 var(--loading-color),0px 0 rgba(255,255,255,0)}50%{box-shadow:130px 0 var(--loading-color),120px 0 var(--loading-color),110px 0 var(--loading-color),100px 0 var(--loading-color)}62%{box-shadow:200px 0 rgba(255,255,255,0),130px 0 var(--loading-color),120px 0 var(--loading-color),110px 0 var(--loading-color)}75%{box-shadow:200px 0 rgba(255,255,255,0),200px 0 rgba(255,255,255,0),130px 0 var(--loading-color),120px 0 var(--loading-color)}87%{box-shadow:200px 0 rgba(255,255,255,0),200px 0 rgba(255,255,255,0),200px 0 rgba(255,255,255,0),130px 0 var(--loading-color)}100%{box-shadow:200px 0 rgba(255,255,255,0),200px 0 rgba(255,255,255,0),200px 0 rgba(255,255,255,0),200px 0 rgba(255,255,255,0)}}</style><link id=favicon rel="shortcut icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMiAzMiI+PGRlZnM+PGNsaXBQYXRoIGlkPSJwcmVmaXhfX2NsaXAtcGF0aCI+PHBhdGggY2xhc3M9InByZWZpeF9fY2xzLTEiIGQ9Ik0yOS40OCAyNS4yNGMtLjE2LTEuODktLjA4LTEuNS0uMjQtMy4xNmE3Mi4yNCA3Mi4yNCAwIDAwLTItMTAuMzdMMjYgNi4yNWwtMi42IDUuNDEtLjQ0Ljg5cS0uMjQuNDgtLjU0IDFhMjAuNDMgMjAuNDMgMCAwMS0xLjI0IDEuODQgMjAuMDggMjAuMDggMCAwMS0zLjA4IDMuMjQgMTkuNzIgMTkuNzIgMCAwMS0zLjg3IDIuNTNjLS43Mi4zMy0xLjQ1LjcxLTIuMjMgMS0uMzQuMTQtMS4xOS40NC0xLjkzLjY2YTIuNTUgMi41NSAwIDAxLTEuMDctLjNjLS4zNC0xLS44My0yLjI0LTEuMi0zLjE5LS41LTEuMjUtMS0yLjUtMS41MS0zLjczYTU5LjExIDU5LjExIDAgMDAtMy42Mi03LjI1IDU5LjgyIDU5LjgyIDAgMDAxLjUxIDcuOTRjLjMgMS4zLjcgMi41OCAxLjA1IDMuODdTNiAyMi43MSA2LjQ0IDI0YTEuNCAxLjQgMCAwMDEuMjkuOTNjMS4yOCAwIDIuNTcuMDYgMy44Ni4wNXMyLjU5IDAgMy44OC0uMTFhNTYgNTYgMCAwMDcuNzktLjg3Yy0xLjkyLS40OS03LjUtLjgxLTEwLjc5LTEuMDZhNDMgNDMgMCAwMDYuNTMtMS43IDI0LjA2IDI0LjA2IDAgMDA1LjM4LTMuNDVjLjcxLS42MiAxLjIxIDEuODggMi4zOSA1LjI3LjYyIDEuNjkuMzQgMSAxIDIuNjZzMS4zNyA0LjM4IDIuMTcgNmMtLjA3LTEuODItLjMxLTQuNjctLjQ2LTYuNDh6Ii8+PC9jbGlwUGF0aD48Y2xpcFBhdGggaWQ9InByZWZpeF9fY2xpcC1wYXRoLTIiPjxwYXRoIGNsYXNzPSJwcmVmaXhfX2Nscy0xIiBkPSJNMjAuOTIgMy40NmE0LjI1IDQuMjUgMCAwMS4zMSA1Ljg2IDMuOTEgMy45MSAwIDAxLTUuNjYuMjQgNC4yNSA0LjI1IDAgMDEtLjMxLTUuODYgMy45MSAzLjkxIDAgMDE1LjY2LS4yNG0xLjM1LTEuNTRhNS44OSA1Ljg5IDAgMDAtOC41My4zNiA2LjQxIDYuNDEgMCAwMC40OCA4LjgzIDUuOTEgNS45MSAwIDAwOC41My0uMzYgNi40MSA2LjQxIDAgMDAtLjQ4LTguODN6Ii8+PC9jbGlwUGF0aD48c3R5bGU+LnByZWZpeF9fY2xzLTF7ZmlsbDojM2UzYTM5fUBtZWRpYSAocHJlZmVycy1jb2xvci1zY2hlbWU6ZGFyayl7LnByZWZpeF9fY2xzLTF7ZmlsbDojZWZlZmVmfX08L3N0eWxlPjwvZGVmcz48ZyBzdHlsZT0iaXNvbGF0aW9uOmlzb2xhdGUiPjxnIGlkPSJwcmVmaXhfX2xheWVyXzEiIGRhdGEtbmFtZT0ibGF5ZXIgMSI+PHBhdGggY2xhc3M9InByZWZpeF9fY2xzLTEiIGQ9Ik0yOS40OCAyNS4yNGMtLjE2LTEuODktLjA4LTEuNS0uMjQtMy4xNmE3Mi4yNCA3Mi4yNCAwIDAwLTItMTAuMzdMMjYgNi4yNWwtMi42IDUuNDEtLjQ0Ljg5cS0uMjQuNDgtLjU0IDFhMjAuNDMgMjAuNDMgMCAwMS0xLjI0IDEuODQgMjAuMDggMjAuMDggMCAwMS0zLjA4IDMuMjQgMTkuNzIgMTkuNzIgMCAwMS0zLjg3IDIuNTNjLS43Mi4zMy0xLjQ1LjcxLTIuMjMgMS0uMzQuMTQtMS4xOS40NC0xLjkzLjY2YTIuNTUgMi41NSAwIDAxLTEuMDctLjNjLS4zNC0xLS44My0yLjI0LTEuMi0zLjE5LS41LTEuMjUtMS0yLjUtMS41MS0zLjczYTU5LjExIDU5LjExIDAgMDAtMy42Mi03LjI1IDU5LjgyIDU5LjgyIDAgMDAxLjUxIDcuOTRjLjMgMS4zLjcgMi41OCAxLjA1IDMuODdTNiAyMi43MSA2LjQ0IDI0YTEuNCAxLjQgMCAwMDEuMjkuOTNjMS4yOCAwIDIuNTcuMDYgMy44Ni4wNXMyLjU5IDAgMy44OC0uMTFhNTYgNTYgMCAwMDcuNzktLjg3Yy0xLjkyLS40OS03LjUtLjgxLTEwLjc5LTEuMDZhNDMgNDMgMCAwMDYuNTMtMS43IDI0LjA2IDI0LjA2IDAgMDA1LjM4LTMuNDVjLjcxLS42MiAxLjIxIDEuODggMi4zOSA1LjI3LjYyIDEuNjkuMzQgMSAxIDIuNjZzMS4zNyA0LjM4IDIuMTcgNmMtLjA3LTEuODItLjMxLTQuNjctLjQ2LTYuNDh6Ii8+PGcgY2xpcC1wYXRoPSJ1cmwoI3ByZWZpeF9fY2xpcC1wYXRoKSI+PHBhdGggY2xhc3M9InByZWZpeF9fY2xzLTEiIGQ9Ik0tLjg3LS43OGgzNC40MnYzMy4wN0gtLjg3eiIvPjwvZz48cGF0aCBjbGFzcz0icHJlZml4X19jbHMtMSIgZD0iTTIwLjkyIDMuNDZhNC4yNSA0LjI1IDAgMDEuMzEgNS44NiAzLjkxIDMuOTEgMCAwMS01LjY2LjI0IDQuMjUgNC4yNSAwIDAxLS4zMS01Ljg2IDMuOTEgMy45MSAwIDAxNS42Ni0uMjRtMS4zNS0xLjU0YTUuODkgNS44OSAwIDAwLTguNTMuMzYgNi40MSA2LjQxIDAgMDAuNDggOC44MyA1LjkxIDUuOTEgMCAwMDguNTMtLjM2IDYuNDEgNi40MSAwIDAwLS40OC04LjgzeiIvPjxnIGNsaXAtcGF0aD0idXJsKCNwcmVmaXhfX2NsaXAtcGF0aC0yKSI+PHBhdGggY2xhc3M9InByZWZpeF9fY2xzLTEiIGQ9Ik0tLjg3LS43OGgzNC40MnYzMy4wN0gtLjg3eiIvPjwvZz48L2c+PC9nPjwvc3ZnPg==" type=image/svg+xml><style>.sf-hidden{display:none!important}</style><link rel=canonical href=https://www.cnblogs.com/autosar/archive/2012/06/22/2558604.html><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:; frame-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style><body class="skin-clearscreen01 has-navbar" inmaintabuse=1><fatkun-drop-panel style=display:none><template shadowroot=open><style>.fatkun-drop-area{user-select:none;font-family:"PingFang SC","Hiragino Sans GB","WenQuanYi Micro Hei","Microsoft Yahei","å¾®è½¯é›…é»‘","Helvetica Neue",Helvetica,Arial,Arial,sans-serif;font-weight:400;z-index:2147483647;position:fixed;top:-999999px;left:-999999px;width:400px;text-align:center;transition:background 0.1s ease-in-out,opacity 0.1s ease-in-out,transform 0.2s ease-in-out,border 0.1s ease-in-out,box-shadow 0.1s ease-in-out;opacity:0;padding:0;transform:translateY(10px);border-radius:10px;box-sizing:border-box;opacity:1;background:#fff;box-shadow:0 0 20px 0 rgba(0,0,0,0.20);border-radius:8px;overflow:hidden;border:1px solid rgba(0,0,0,0.5)}.fatkun-drop-area.show{transition:transform 50ms ease;transform:translateY(0px)}#fatkun-drop-area-overlay{z-index:1147483646;position:fixed;top:0;left:0;width:100%;height:100%;opacity:0;background:rgba(33,33,33,0.5);user-select:none;pointer-events:none;transition:opacity 50ms ease}#fatkun-drop-area-overlay.show{opacity:1}.fatkun-drop-area .fatkun-drop-area-content{display:flex;text-align:left;flex-direction:row;flex-shrink:initial}.fatkun-drop-area .fatkun-drop-area-content .fatkun-left-panel{position:relative;min-width:200px;width:200px;min-height:200px;align-items:center}.fatkun-drop-area .fatkun-drop-area-content .fatkun-left-panel .fatkun-drop-area-item{text-align:center;display:flex;flex-shrink:initial;flex-direction:row;align-items:center;background-color:#f1f2f4;border-radius:0;padding:0 16px;position:absolute;top:0;left:0;right:0;bottom:0;height:auto!important}.fatkun-drop-area .fatkun-drop-area-content .fatkun-left-panel .fatkun-drop-area-item.dragenter{background-color:#e1e2e4}.fatkun-drop-area .fatkun-drop-area-content .fatkun-left-panel .fatkun-drop-area-item .title{font-size:14px!important;overflow:initial!important}.fatkun-drop-area .fatkun-drop-area-content .fatkun-right-panel{padding:5px;flex:1;max-width:calc(100% - 200px)}.fatkun-drop-area.old-version{width:200px}.fatkun-drop-area.old-version .fatkun-drop-area-content .fatkun-left-panel .fatkun-drop-area-item{right:0}.fatkun-drop-area.old-version .fatkun-drop-area-content .fatkun-right-panel{display:none}.fatkun-drop-area .fatkun-drop-area-content .fatkun-drop-area-item{height:32px;display:flex!important;align-items:center!important;border-radius:5px;padding:0 12px;transition:all 80ms ease}.fatkun-drop-area .fatkun-drop-area-content .fatkun-right-panel .fatkun-drop-area-item .title{align-self:flex-start!important}.fatkun-drop-area .fatkun-drop-area-content .fatkun-drop-area-item.all{}.fatkun-drop-area .fatkun-drop-area-content .fatkun-drop-area-item.dragenter{background-color:#f1f2f4}.fatkun-drop-area .fatkun-drop-area-content .fatkun-drop-area-item *{pointer-events:none;flex-shrink:initial;max-width:100%}.fatkun-drop-area .fatkun-drop-area-content hr{border:0!important;height:1px!important;margin:5px 0!important;background-color:#e9e9e9!important;display:block!important}.fatkun-drop-area .fatkun-drop-area-content .icon{height:32px;width:32px;line-height:32px;text-align:center;margin:0 auto 20px!important;background:rgba(128,128,128,0.20);border-radius:50%;transition:all 0.3s ease-in-out}.fatkun-drop-area .fatkun-drop-area-content .icon .fake-svg{-webkit-mask:url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c3ZnIHdpZHRoPSIxM3B4IiBoZWlnaHQ9IjE1cHgiIHZpZXdCb3g9IjAgMCAxMyAxNSIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj4gICAgICAgIDx0aXRsZT5pY19kb3dubG9hZF9ub3JtYWw8L3RpdGxlPiAgICA8ZGVzYz5DcmVhdGVkIHdpdGggU2tldGNoLjwvZGVzYz4gICAgPGcgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+ICAgICAgICA8ZyBpZD0i5paw54mI5pys5ouW5ou95qaC5b+1LS0t5ouW5ou96Kem5Y+RIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtODE0LjAwMDAwMCwgLTM2Mi4wMDAwMDApIiBmaWxsPSIjMzMzMzMzIj4gICAgICAgICAgICA8ZyBpZD0iR3JvdXAtMyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNzA5LjAwMDAwMCwgMjg5LjAwMDAwMCkiPiAgICAgICAgICAgICAgICA8ZyBpZD0iR3JvdXAtNyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjUuMDAwMDAwLCA2MS4wMDAwMDApIj4gICAgICAgICAgICAgICAgICAgIDxnIGlkPSJHcm91cC02IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg2Ny40NTAwMDAsIDAuMDAwMDAwKSI+ICAgICAgICAgICAgICAgICAgICAgICAgPGcgaWQ9ImFycm93LWRvd24iIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEyLjM1MDAwMCwgMTIuMzUwMDAwKSI+ICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJpY19kb3dubG9hZF9ub3JtYWwiIHBvaW50cz0iNi42NSAxMy43NzUgMC40NzUgNy42IDMuOCA3LjYgMy44IDAgOS41IDAgOS41IDcuNiAxMi44MjUgNy42Ij48L3BvbHlnb24+ICAgICAgICAgICAgICAgICAgICAgICAgPC9nPiAgICAgICAgICAgICAgICAgICAgPC9nPiAgICAgICAgICAgICAgICA8L2c+ICAgICAgICAgICAgPC9nPiAgICAgICAgPC9nPiAgICA8L2c+PC9zdmc+)no-repeat center center;height:32px;width:32px;background:#666;transition:all 0.3s ease-in-out;animation:icon-jump 1.5s ease 0s infinite normal}.fatkun-drop-area .fatkun-drop-area-content .title{font-family:"PingFang SC","Hiragino Sans GB","WenQuanYi Micro Hei","Microsoft Yahei","å¾®è½¯é›…é»‘","Helvetica Neue",Helvetica,Arial,Arial,sans-serif;font-size:12px!important;font-weight:400!important;line-height:32px!important;overflow:hidden!important;white-space:nowrap!important;text-overflow:ellipsis!important;-webkit-font-smoothing:antialiased!important;-moz-osx-font-smoothing:grayscale!important;color:#111!important;margin:0!important;display:block!important;transition:all 0.3s ease-in-out;max-width:100%}.fatkun-drop-area .fatkun-drop-area-content .description{font-family:"PingFang SC","Hiragino Sans GB","WenQuanYi Micro Hei","Microsoft Yahei","å¾®è½¯é›…é»‘","Helvetica Neue",Helvetica,Arial,Arial,sans-serif;font-size:12px!important;font-weight:400!important;-webkit-font-smoothing:antialiased!important;-moz-osx-font-smoothing:grayscale!important;margin-top:12px!important;margin-bottom:0!important;line-height:1.5!important;color:#111!important;opacity:0.6;transition:all 0.3s ease-in-out;max-width:100%}.fatkun-drop-area.dragover{opacity:1}@media (prefers-color-scheme:dark){.fatkun-drop-area{background:rgba(37,37,40,0.98);box-shadow:0 0 20px 0 rgba(0,0,0,0.20);border:none}#fatkun-drop-area-overlay{background:rgba(72,72,72,0.3)}.fatkun-drop-area .fatkun-drop-area-content .fatkun-right-panel{background-color:rgba(255,255,255,0.05)}.fatkun-drop-area .fatkun-drop-area-content .fatkun-right-panel .fatkun-drop-area-item.dragenter{background-color:rgba(255,255,255,0.10)}.fatkun-drop-area .fatkun-drop-area-content .fatkun-left-panel .fatkun-drop-area-item{background-color:rgba(0,0,0,0.05)}.fatkun-drop-area .fatkun-drop-area-content .fatkun-left-panel .fatkun-drop-area-item.dragenter{background-color:rgba(255,255,255,0.10)}.fatkun-drop-area .fatkun-drop-area-content hr{background-color:rgba(255,255,255,0.1)!important}.fatkun-drop-area .fatkun-drop-area-content .title{color:#fff!important}.fatkun-drop-area .fatkun-drop-area-content .description{color:#fff!important;opacity:0.7}.fatkun-drop-area .fatkun-drop-area-content .icon{background:rgba(255,255,255,0.10)}.fatkun-drop-area .fatkun-drop-area-content .icon .fake-svg{background:#fff}}@keyframes icon-jump{0%{transform:translateY(0)}20%{transform:translateY(0)}40%{transform:translateY(-20px)}50%{transform:translateY(0)}60%{transform:translateY(-7px)}80%{transform:translateY(0)}100%{transform:translateY(0)}}.fatkun-drop-bottom-area{font-family:"PingFang SC","Hiragino Sans GB","WenQuanYi Micro Hei","Microsoft Yahei","å¾®è½¯é›…é»‘","Helvetica Neue",Helvetica,Arial,Arial,sans-serif;font-weight:400;z-index:2147483647;position:fixed;right:0;left:0;bottom:0;height:120px;text-align:center;transition:opacity 0.3s ease-in-out,transform 0.2s ease-in-out,border 0.3s ease-in-out,box-shadow 0.2s ease-in-out;-webkit-perspective:1000;transform:translateY(100%);background:#303034;border-top:1px solid rgba(255,255,255,0.07);box-sizing:border-box}.fatkun-drop-bottom-area .fatkun-drop-area-content{position:absolute;top:50%;width:100%;transform:translateY(-50%);display:flex;flex-direction:row;align-items:center;justify-content:center}.fatkun-drop-bottom-area .fatkun-drop-area-content .icon{height:44px;width:44px;line-height:44px;text-align:center;background:rgba(255,255,255,0.20);border-radius:50%;transition:all 0.3s ease-in-out;margin-right:24px}.fatkun-drop-bottom-area .fatkun-drop-area-content .icon .fake-svg{-webkit-mask:url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c3ZnIHdpZHRoPSIxM3B4IiBoZWlnaHQ9IjE1cHgiIHZpZXdCb3g9IjAgMCAxMyAxNSIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj4gICAgICAgIDx0aXRsZT5pY19kb3dubG9hZF9ub3JtYWw8L3RpdGxlPiAgICA8ZGVzYz5DcmVhdGVkIHdpdGggU2tldGNoLjwvZGVzYz4gICAgPGcgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+ICAgICAgICA8ZyBpZD0i5paw54mI5pys5ouW5ou95qaC5b+1LS0t5ouW5ou96Kem5Y+RIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtODE0LjAwMDAwMCwgLTM2Mi4wMDAwMDApIiBmaWxsPSIjMzMzMzMzIj4gICAgICAgICAgICA8ZyBpZD0iR3JvdXAtMyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNzA5LjAwMDAwMCwgMjg5LjAwMDAwMCkiPiAgICAgICAgICAgICAgICA8ZyBpZD0iR3JvdXAtNyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjUuMDAwMDAwLCA2MS4wMDAwMDApIj4gICAgICAgICAgICAgICAgICAgIDxnIGlkPSJHcm91cC02IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg2Ny40NTAwMDAsIDAuMDAwMDAwKSI+ICAgICAgICAgICAgICAgICAgICAgICAgPGcgaWQ9ImFycm93LWRvd24iIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEyLjM1MDAwMCwgMTIuMzUwMDAwKSI+ICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJpY19kb3dubG9hZF9ub3JtYWwiIHBvaW50cz0iNi42NSAxMy43NzUgMC40NzUgNy42IDMuOCA3LjYgMy44IDAgOS41IDAgOS41IDcuNiAxMi44MjUgNy42Ij48L3BvbHlnb24+ICAgICAgICAgICAgICAgICAgICAgICAgPC9nPiAgICAgICAgICAgICAgICAgICAgPC9nPiAgICAgICAgICAgICAgICA8L2c+ICAgICAgICAgICAgPC9nPiAgICAgICAgPC9nPiAgICA8L2c+PC9zdmc+)no-repeat center center;height:44px;width:44px;background:#fff;transition:all 0.3s ease-in-out;animation:icon-jump 1s ease 0s infinite normal}.fatkun-drop-bottom-area .fatkun-drop-area-content .title{font-family:"PingFang SC","Hiragino Sans GB","WenQuanYi Micro Hei","Microsoft Yahei","å¾®è½¯é›…é»‘","Helvetica Neue",Helvetica,Arial,Arial,sans-serif;font-size:18px!important;font-weight:500!important;-webkit-font-smoothing:antialiased!important;-moz-osx-font-smoothing:grayscale!important;color:#fff!important;transition:all 0.3s ease-in-out}.fatkun-drop-bottom-area.show{opacity:0.8;transform:translateY(0) scale3d(1,1,1)}.fatkun-drop-bottom-area.dragover{opacity:0.95}#fatkun-drop-panel-close-btn{z-index:1;display:block;width:24px;height:24px;position:absolute;right:0px;top:0px;font-size:24px;color:#000;text-align:center;text-decoration:none;line-height:24px}</style>
 
 
</template></fatkun-drop-panel>
 <a name=top></a>
 
 
 
<div id=header>
 

</div>


<div id=main>
 
 <div id=centercontent class>
 <div id=post_detail>
<div class=post>
 <div class=postTitle><a id=cb_post_title_url class="postTitle2 vertical-middle" href=https://www.cnblogs.com/autosar/archive/2012/06/22/2558604.html><span role=heading aria-level=2 class>设计模式｜有限状态机</span></a></div>
 <div id=cnblogs_post_body class="blogpost-body blogpost-body-html">
   <p class>首先，分析一下一个普通的状态机究竟要实现哪些内容。</p> <p>状态机存储从开始时刻到现在的变化，并根据当前输入，决定下一个状态。<p>这意味着，状态机要存储状态、获得输入（跳转条件）、做出响应。</p> <p class><a href=http://images.cnblogs.com/cnblogs_com/autosar/201206/201206221216485800.png rel=noopener><img style=border:0;display:inline title=image border=0 alt=image src="data:image/png;base64,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" width=206 height=183></a> </p> <p>如上图所示，{s1, s2, s3}均为状态，箭头c1/a1表示在s1状态、输入为c1时，跳转到s2，并进行a1操作。</p> <p>最下方为一组输入，状态机应做出如下反应：</p> <div class=table-wrapper><table border=0 cellspacing=0 cellpadding=2 width=400> <tbody> <tr> <td valign=top width=100>&nbsp; 当前状态</td> <td valign=top width=100>&nbsp; &nbsp; &nbsp; 输入</td> <td valign=top width=100>下一个状态</td> <td valign=top width=100>&nbsp; &nbsp; &nbsp;动作</tr> <tr> <td valign=top width=100>&nbsp; &nbsp; &nbsp; &nbsp;s1</td> <td valign=top width=100>&nbsp; &nbsp; &nbsp; &nbsp;c1</td> <td valign=top width=100>&nbsp; &nbsp; &nbsp; &nbsp;s2</td> <td valign=top width=100>&nbsp; &nbsp; &nbsp; a1</tr> <tr> <td valign=top width=100>&nbsp; &nbsp; &nbsp; &nbsp;s2</td> <td valign=top width=100>&nbsp; &nbsp; &nbsp; &nbsp;c2</td> <td valign=top width=100>&nbsp; &nbsp; &nbsp; &nbsp;s3</td> <td valign=top width=100>&nbsp; &nbsp; &nbsp; a2</tr> <tr> <td valign=top width=100>&nbsp; &nbsp; &nbsp; &nbsp;s3</td> <td valign=top width=100>&nbsp; &nbsp; &nbsp; &nbsp;c1</td> <td valign=top width=100>&nbsp; &nbsp; &nbsp; &nbsp;s2</td> <td valign=top width=100>&nbsp; &nbsp; &nbsp; a3</tr> <tr> <td valign=top width=100>&nbsp; &nbsp; &nbsp; &nbsp;s2</td> <td valign=top width=100>&nbsp; &nbsp; &nbsp; &nbsp;c2</td> <td valign=top width=100>&nbsp; &nbsp; &nbsp; &nbsp;s3</td> <td valign=top width=100>&nbsp; &nbsp; &nbsp; a2</tr> <tr> <td valign=top width=100>&nbsp; &nbsp; &nbsp; &nbsp;s3</td> <td valign=top width=100>&nbsp; &nbsp; &nbsp; &nbsp;c1</td> <td valign=top width=100>&nbsp; &nbsp; &nbsp; &nbsp;s2</td> <td valign=top width=100>&nbsp; &nbsp; &nbsp; a3</tr> <tr> <td valign=top width=100>&nbsp; &nbsp; &nbsp; &nbsp;s2</td> <td valign=top width=100>&nbsp; &nbsp; &nbsp; &nbsp;c1</td> <td valign=top width=100>&nbsp; &nbsp; s_trap</td> <td valign=top width=100>&nbsp; &nbsp;a_trap</tr> <tr> <td valign=top width=100>&nbsp; &nbsp; s_trap</td> <td valign=top width=100>&nbsp; &nbsp; &nbsp; &nbsp;c1</td> <td valign=top width=100>&nbsp; &nbsp; s_trap</td> <td valign=top width=100>&nbsp; &nbsp;a_trap</table></div> <p>&nbsp;当某个状态遇到不能识别的输入时，就默认进入陷阱状态，在陷阱状态中，不论遇到怎样的输入都不能跳出。</p> <p>为了表达上面这个自动机，我们定义它们的状态和输入类型：<div><div id=highlighter_323429 class="syntaxhighlighter cpp"><div class="toolbar sf-hidden"></div><table border=0 cellpadding=0 cellspacing=0><tbody><tr><td class=gutter><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><td class=code><div class=container><div class="line number1 index0 alt2"><code class="cpp keyword bold">typedef</code> <code class="cpp color1 bold">int</code> <code class="cpp plain">State;</code></div><div class="line number2 index1 alt1"><code class="cpp keyword bold">typedef</code> <code class="cpp color1 bold">int</code> <code class="cpp plain">Condition;</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="cpp preprocessor">#define STATES 3 + 1</code></div><div class="line number5 index4 alt2"><code class="cpp preprocessor">#define STATE_1 0</code></div><div class="line number6 index5 alt1"><code class="cpp preprocessor">#define STATE_2 1</code></div><div class="line number7 index6 alt2"><code class="cpp preprocessor">#define STATE_3 2</code></div><div class="line number8 index7 alt1"><code class="cpp preprocessor">#define STATE_TRAP 3</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="cpp preprocessor">#define CONDITIONS 2</code></div><div class="line number11 index10 alt2"><code class="cpp preprocessor">#define CONDITION_1 0</code></div><div class="line number12 index11 alt1"><code class="cpp preprocessor">#define CONDITION_2 1</code></div></div></table></div></div>
<p>&nbsp;在嵌入式环境中，由于存储空间比较小，因此把它们全部定义成宏。<p>此外，为了降低执行时间的不确定性，我们使用O(1)的跳转表来模拟状态的跳转。</p>
<p>首先定义跳转类型：<div><div id=highlighter_844632 class="syntaxhighlighter cpp"><div class="toolbar sf-hidden"></div><table border=0 cellpadding=0 cellspacing=0><tbody><tr><td class=gutter><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><td class=code><div class=container><div class="line number1 index0 alt2"><code class="cpp keyword bold">typedef</code> <code class="cpp keyword bold">void</code> <code class="cpp plain">(*ActionType)(State state, Condition condition);</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="cpp keyword bold">typedef</code> <code class="cpp keyword bold">struct</code></div><div class="line number4 index3 alt1"><code class="cpp plain">{</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">State next;</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">ActionType action;</code></div><div class="line number7 index6 alt2"><code class="cpp plain">} Trasition, * pTrasition;</code></div></div></table></div></div>
<p>&nbsp;然后按照上图中的跳转关系，把三个跳转加一个陷阱跳转先定义出来：<div><div id=highlighter_977298 class="syntaxhighlighter cpp"><div class="toolbar sf-hidden"></div><table border=0 cellpadding=0 cellspacing=0><tbody><tr><td class=gutter><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><td class=code><div class=container><div class="line number1 index0 alt2"><code class="cpp comments">// (s1, c1, s2, a1)</code></div><div class="line number2 index1 alt1"><code class="cpp plain">Trasition t1 = {</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">STATE_2,</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">action_1</code></div><div class="line number5 index4 alt2"><code class="cpp plain">};</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="cpp comments">// (s2, c2, s3, a2)</code></div><div class="line number8 index7 alt1"><code class="cpp plain">Trasition t2 = {</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">STATE_3,</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">action_2</code></div><div class="line number11 index10 alt2"><code class="cpp plain">};</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="cpp comments">// (s3, c1, s2, a3)</code></div><div class="line number14 index13 alt1"><code class="cpp plain">Trasition t3 = {</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">STATE_2,</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">action_3</code></div><div class="line number17 index16 alt2"><code class="cpp plain">};</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="cpp comments">// (s, c, trap, a1)</code></div><div class="line number20 index19 alt1"><code class="cpp plain">Trasition tt = {</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">STATE_TRAP,</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">action_trap</code></div><div class="line number23 index22 alt2"><code class="cpp plain">};</code></div></div></table></div></div>
<p>&nbsp;其中的动作，由用户自己完成，在这里仅定义一条输出语句。<div><div id=highlighter_541936 class="syntaxhighlighter cpp"><div class="toolbar sf-hidden"></div><table border=0 cellpadding=0 cellspacing=0><tbody><tr><td class=gutter><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><td class=code><div class=container><div class="line number1 index0 alt2"><code class="cpp keyword bold">void</code> <code class="cpp plain">action_1(State state, Condition condition)</code></div><div class="line number2 index1 alt1"><code class="cpp plain">{</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">printf</code><code class="cpp plain">(</code><code class="cpp string">"Action 1 triggered.\n"</code><code class="cpp plain">);</code></div><div class="line number4 index3 alt1"><code class="cpp plain">}</code></div></div></table></div></div><div><div id=highlighter_538686 class="syntaxhighlighter cpp"><div class="toolbar sf-hidden"></div><table border=0 cellpadding=0 cellspacing=0><tbody><tr><td class=gutter><div class="line number1 index0 alt2">1</div><td class=code><div class=container><div class="line number1 index0 alt2"><code class="cpp plain">最后定义跳转表：</code></div></div></table></div></div><div><div id=highlighter_326638 class="syntaxhighlighter cpp"><div class="toolbar sf-hidden"></div><table border=0 cellpadding=0 cellspacing=0><tbody><tr><td class=gutter><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><td class=code><div class=container><div class="line number1 index0 alt2"><code class="cpp plain">pTrasition transition_table[STATES][CONDITIONS] = {</code></div><div class="line number2 index1 alt1"><code class="cpp comments">/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c1,&nbsp; c2*/</code></div><div class="line number3 index2 alt2"><code class="cpp comments">/* s1 */</code><code class="cpp plain">&amp;t1, &amp;tt,</code></div><div class="line number4 index3 alt1"><code class="cpp comments">/* s2 */</code><code class="cpp plain">&amp;tt, &amp;t2,</code></div><div class="line number5 index4 alt2"><code class="cpp comments">/* s3 */</code><code class="cpp plain">&amp;t3, &amp;tt,</code></div><div class="line number6 index5 alt1"><code class="cpp comments">/* st */</code><code class="cpp plain">&amp;tt, &amp;tt,</code></div><div class="line number7 index6 alt2"><code class="cpp plain">};</code></div></div></table></div></div>
<p>&nbsp;即可表达上文中的跳转关系。</p>
<p>最后定义状态机，如果不考虑多任务请求，那么状态机仅需要存储当前状态便行了。例如：<div><div id=highlighter_704097 class="syntaxhighlighter cpp"><div class="toolbar sf-hidden"></div><table border=0 cellpadding=0 cellspacing=0><tbody><tr><td class=gutter><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><td class=code><div class=container><div class="line number1 index0 alt2"><code class="cpp keyword bold">typedef</code> <code class="cpp keyword bold">struct</code></div><div class="line number2 index1 alt1"><code class="cpp plain">{</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">State current;</code></div><div class="line number4 index3 alt1"><code class="cpp plain">} StateMachine, * pStateMachine;</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="cpp plain">State step(pStateMachine machine, Condition condition)</code></div><div class="line number7 index6 alt2"><code class="cpp plain">{</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">pTrasition t = transition_table[machine-&gt;current][condition];</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">(*(t-&gt;action))(machine-&gt;current, condition);</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">machine-&gt;current = t-&gt;next;</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">machine-&gt;current;</code></div><div class="line number12 index11 alt1"><code class="cpp plain">}</code></div></div></table></div></div>
<p>&nbsp;但是考虑到当一个跳转正在进行的时候，同时又有其他任务请求跳转，则会出现数据不一致的问题。</p>
<p>举个例子：<p>task1(s1, c1/a1 –&gt; s2)和task2(s2, c2/a2 –&gt; s3)先后执行，是可以顺利到达s3状态的，<p>但若操作a1运行的时候，执行权限被task2抢占，则task2此时看到的当前状态还是s1，s1遇到c2就进入陷阱状态，而不会到达s3了，<p>也就是说，状态的跳转发生了不确定，这是不能容忍的。</p>
<p>&nbsp;因此要重新设计状态机，增加一个“事务中”条件和一个用于存储输入的条件队列。修改后的代码如下:<div><div id=highlighter_542115 class="syntaxhighlighter cpp"><div class="toolbar sf-hidden"></div><table border=0 cellpadding=0 cellspacing=0><tbody><tr><td class=gutter><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div><div class="line number67 index66 alt2">67</div><div class="line number68 index67 alt1">68</div><div class="line number69 index68 alt2">69</div><div class="line number70 index69 alt1">70</div><div class="line number71 index70 alt2">71</div><div class="line number72 index71 alt1">72</div><div class="line number73 index72 alt2">73</div><div class="line number74 index73 alt1">74</div><div class="line number75 index74 alt2">75</div><div class="line number76 index75 alt1">76</div><div class="line number77 index76 alt2">77</div><div class="line number78 index77 alt1">78</div><div class="line number79 index78 alt2">79</div><div class="line number80 index79 alt1">80</div><div class="line number81 index80 alt2">81</div><div class="line number82 index81 alt1">82</div><div class="line number83 index82 alt2">83</div><div class="line number84 index83 alt1">84</div><div class="line number85 index84 alt2">85</div><div class="line number86 index85 alt1">86</div><div class="line number87 index86 alt2">87</div><div class="line number88 index87 alt1">88</div><div class="line number89 index88 alt2">89</div><div class="line number90 index89 alt1">90</div><div class="line number91 index90 alt2">91</div><div class="line number92 index91 alt1">92</div><div class="line number93 index92 alt2">93</div><div class="line number94 index93 alt1">94</div><div class="line number95 index94 alt2">95</div><div class="line number96 index95 alt1">96</div><div class="line number97 index96 alt2">97</div><div class="line number98 index97 alt1">98</div><div class="line number99 index98 alt2">99</div><div class="line number100 index99 alt1">100</div><div class="line number101 index100 alt2">101</div><td class=code><div class=container><div class="line number1 index0 alt2"><code class="cpp preprocessor">#define E_OK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0</code></div><div class="line number2 index1 alt1"><code class="cpp preprocessor">#define E_NO_DATA&nbsp;&nbsp;&nbsp; 1</code></div><div class="line number3 index2 alt2"><code class="cpp preprocessor">#define E_OVERFLOW&nbsp;&nbsp;&nbsp; 2</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="cpp keyword bold">typedef</code> <code class="cpp keyword bold">struct</code></div><div class="line number6 index5 alt1"><code class="cpp plain">{</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Condition queue[QMAX];</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">int</code> <code class="cpp plain">head;</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">int</code> <code class="cpp plain">tail;</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">bool</code> <code class="cpp plain">overflow;</code></div><div class="line number11 index10 alt2"><code class="cpp plain">} ConditionQueue, * pConditionQueue;</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2">&nbsp;</div><div class="line number14 index13 alt1"><code class="cpp color1 bold">int</code> <code class="cpp plain">push(ConditionQueue * queue, Condition c)</code></div><div class="line number15 index14 alt2"><code class="cpp plain">{&nbsp;&nbsp;&nbsp; </code></div><div class="line number16 index15 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">unsigned </code><code class="cpp color1 bold">int</code> <code class="cpp plain">flags;</code></div><div class="line number17 index16 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Irq_Save(flags);</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">((queue-&gt;head == queue-&gt;tail + 1) || ((queue-&gt;head == 0) &amp;&amp; (queue-&gt;tail == 0)))</code></div><div class="line number19 index18 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">queue-&gt;overflow = </code><code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Irq_Restore(flags);</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">E_OVERFLOW;</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number24 index23 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">else</code></div><div class="line number25 index24 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{</code></div><div class="line number26 index25 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">queue-&gt;queue[queue-&gt;tail] = c;</code></div><div class="line number27 index26 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">queue-&gt;tail = (queue-&gt;tail + 1) % QMAX;</code></div><div class="line number28 index27 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Irq_Restore(flags);</code></div><div class="line number29 index28 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number30 index29 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">E_OK;</code></div><div class="line number31 index30 alt2"><code class="cpp plain">}</code></div><div class="line number32 index31 alt1">&nbsp;</div><div class="line number33 index32 alt2"><code class="cpp color1 bold">int</code> <code class="cpp plain">poll(ConditionQueue * queue, Condition * c)</code></div><div class="line number34 index33 alt1"><code class="cpp plain">{</code></div><div class="line number35 index34 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">unsigned </code><code class="cpp color1 bold">int</code> <code class="cpp plain">flags;</code></div><div class="line number36 index35 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Irq_Save(flags);</code></div><div class="line number37 index36 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(queue-&gt;head == queue-&gt;tail)</code></div><div class="line number38 index37 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{</code></div><div class="line number39 index38 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Irq_Restore(flags);</code></div><div class="line number40 index39 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">E_NO_DATA;</code></div><div class="line number41 index40 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number42 index41 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">else</code></div><div class="line number43 index42 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{</code></div><div class="line number44 index43 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">*c = queue-&gt;queue[queue-&gt;head];</code></div><div class="line number45 index44 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">queue-&gt;overflow = </code><code class="cpp keyword bold">false</code><code class="cpp plain">;</code></div><div class="line number46 index45 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">queue-&gt;head = (queue-&gt;head + 1) % QMAX;</code></div><div class="line number47 index46 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Irq_Restore(flags);</code></div><div class="line number48 index47 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number49 index48 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">E_OK;</code></div><div class="line number50 index49 alt1"><code class="cpp plain">}</code></div><div class="line number51 index50 alt2">&nbsp;</div><div class="line number52 index51 alt1"><code class="cpp keyword bold">typedef</code> <code class="cpp keyword bold">struct</code></div><div class="line number53 index52 alt2"><code class="cpp plain">{</code></div><div class="line number54 index53 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">State current;</code></div><div class="line number55 index54 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">bool</code> <code class="cpp plain">inTransaction;</code></div><div class="line number56 index55 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">ConditionQueue queue;</code></div><div class="line number57 index56 alt2"><code class="cpp plain">} StateMachine, * pStateMachine;</code></div><div class="line number58 index57 alt1">&nbsp;</div><div class="line number59 index58 alt2"><code class="cpp keyword bold">static</code> <code class="cpp plain">State __step(pStateMachine machine, Condition condition)</code></div><div class="line number60 index59 alt1"><code class="cpp plain">{</code></div><div class="line number61 index60 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">State current = machine -&gt; current;</code></div><div class="line number62 index61 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">pTrasition t = transition_table[current][condition];</code></div><div class="line number63 index62 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">(*(t-&gt;action))(current, condition);</code></div><div class="line number64 index63 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">current = t-&gt;next;</code></div><div class="line number65 index64 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">machine-&gt;current = current;</code></div><div class="line number66 index65 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">current;</code></div><div class="line number67 index66 alt2"><code class="cpp plain">}</code></div><div class="line number68 index67 alt1">&nbsp;</div><div class="line number69 index68 alt2"><code class="cpp plain">State step(pStateMachine machine, Condition condition)</code></div><div class="line number70 index69 alt1"><code class="cpp plain">{</code></div><div class="line number71 index70 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Condition next_condition;</code></div><div class="line number72 index71 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">int</code> <code class="cpp plain">status;</code></div><div class="line number73 index72 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">State current;</code></div><div class="line number74 index73 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(machine-&gt;inTransaction)</code></div><div class="line number75 index74 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{</code></div><div class="line number76 index75 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">push(&amp;(machine-&gt;queue), condition);</code></div><div class="line number77 index76 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">STATE_INTRANSACTION;</code></div><div class="line number78 index77 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number79 index78 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">else</code></div><div class="line number80 index79 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{</code></div><div class="line number81 index80 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">machine-&gt;inTransaction = </code><code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number82 index81 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">current = __step(machine, condition);</code></div><div class="line number83 index82 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">status = poll(&amp;(machine-&gt;queue), &amp;next_condition);</code></div><div class="line number84 index83 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">while</code><code class="cpp plain">(status == E_OK)</code></div><div class="line number85 index84 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{</code></div><div class="line number86 index85 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">__step(machine, next_condition);</code></div><div class="line number87 index86 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">status = poll(&amp;(machine-&gt;queue), &amp;next_condition);</code></div><div class="line number88 index87 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number89 index88 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">machine-&gt;inTransaction = </code><code class="cpp keyword bold">false</code><code class="cpp plain">;</code></div><div class="line number90 index89 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">current;</code></div><div class="line number91 index90 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number92 index91 alt1"><code class="cpp plain">}</code></div><div class="line number93 index92 alt2">&nbsp;</div><div class="line number94 index93 alt1"><code class="cpp keyword bold">void</code> <code class="cpp plain">initialize(pStateMachine machine, State s)</code></div><div class="line number95 index94 alt2"><code class="cpp plain">{</code></div><div class="line number96 index95 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">machine-&gt;current = s;</code></div><div class="line number97 index96 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">machine-&gt;inTransaction = </code><code class="cpp keyword bold">false</code><code class="cpp plain">;</code></div><div class="line number98 index97 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">machine-&gt;queue.head = 0;</code></div><div class="line number99 index98 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">machine-&gt;queue.tail = 0;</code></div><div class="line number100 index99 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">machine-&gt;queue.overflow = </code><code class="cpp keyword bold">false</code><code class="cpp plain">;</code></div><div class="line number101 index100 alt2"><code class="cpp plain">}</code></div></div></table></div></div>
<p class>&nbsp;<p class>https://www.cnblogs.com/autosar/archive/2012/06/22/2558604.html<p class><img src=data:image/png;base64,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><br></p>
<div><div id=highlighter_516727 class="syntaxhighlighter cpp"><div class="toolbar sf-hidden"></div><table border=0 cellpadding=0 cellspacing=0><tbody><tr><td class=gutter><td class=code><div class=container></div></table></div></div>
</div>
<div class=clear></div>

 
</div>
<a id=!comments></a>
<div id=blog-comments-placeholder class=sf-hidden></div>

</div>
 </div>
</div>

 
 
 
<div id=photoShowViewer class="sb_BingCA photoShow">
 <div class=photoshow-viewer-shadow></div>
 <div class="photoshow-img-wrapper sf-hidden">
 
 
 </div>
 <i class=photoshow-img-size></i>
 </div><div id=qk-ext-root class=wSsllC9wCXlJ1wygj1YQ></div><script data-template-shadow-root>(()=>{document.currentScript.remove();processNode(document);function processNode(node){node.querySelectorAll("template[shadowroot]").forEach(element=>{let shadowRoot = element.parentElement.shadowRoot;if (!shadowRoot) {try {shadowRoot=element.parentElement.attachShadow({mode:element.getAttribute("shadowroot")});shadowRoot.innerHTML=element.innerHTML;element.remove()} catch (error) {} if (shadowRoot) {processNode(shadowRoot)}}})}})()</script><style>.single-file-highlight-yellow, .single-file-highlight-yellow-mode ::selection { background-color: #ffff7c !important; color: black !important; } .single-file-highlight-pink, .single-file-highlight-pink-mode ::selection { background-color: #ffbbb6 !important; color: black !important; } .single-file-highlight-blue, .single-file-highlight-blue-mode ::selection { background-color: #95d0ff !important; color: black !important; } .single-file-highlight-green, .single-file-highlight-green-mode ::selection { background-color: #93ef8d !important; color: black !important; } span.single-file-highlight-yellow, span.single-file-highlight-pink, span.single-file-highlight-blue, span.single-file-highlight-green { display: inline !important; } .single-file-highlight-hidden { background-color: inherit !important; color: inherit !important; } .single-file-mask { all: initial; display: contents !important; } .single-file-mask.single-file-page-mask { opacity: .99 !important; } single-file-note { all: initial !important; display: contents !important; } .single-file-cut-hover, .single-file-cut-outer-hover, .single-file-cut-selected, .single-file-cut-outer-selected { transition: outline-width 125ms !important; outline-offset: -4px !important; outline-width: 4px !important; } .single-file-cut-hover, .single-file-cut-outer-hover { outline-style: dotted !important; } .single-file-cut-selected, .single-file-cut-outer-selected { outline-style: dashed !important; } .single-file-cut-hover, .single-file-cut-selected { outline-color: red !important; } .single-file-cut-outer-hover, .single-file-cut-outer-selected { outline-color: green !important; } .single-file-cut-mode, .single-file-cut-mode * { pointer-events: auto !important; touch-action: none !important; } .single-file-cut-hover, .single-file-cut-outer-hover, .single-file-remove-highlights-mode .single-file-highlight:hover { cursor: crosshair !important; } .single-file-removed { display: none !important; float: none !important; position: static !important; visibility: collapse !important; } a[href], img { -webkit-touch-callout: none; }</style><script data-template-shadow-root>(() => { document.currentScript.remove(); const processNode = node => { node.querySelectorAll("template[shadowroot]").forEach(element=>{ let shadowRoot = getShadowRoot(element.parentElement); if (!shadowRoot) { try { shadowRoot = element.parentElement.attachShadow({mode:element.getAttribute("shadowroot")}); shadowRoot.innerHTML = element.innerHTML; element.remove(); } catch (error) {} if (shadowRoot) { processNode(shadowRoot); } } }) }; const FORBIDDEN_TAG_NAMES = ["a","area","audio","base","br","col","command","embed","hr","img","iframe","input","keygen","link","meta","param","source","track","video","wbr"]; const NOTE_TAGNAME = "single-file-note"; const NOTE_CLASS = "note"; const NOTE_ANCHORED_CLASS = "note-anchored"; const NOTE_SELECTED_CLASS = "note-selected"; const NOTE_MOVING_CLASS = "note-moving"; const NOTE_MASK_MOVING_CLASS = "note-mask-moving"; const MASK_CLASS = "single-file-mask"; const HIGHLIGHT_CLASS = "single-file-highlight"; const NOTES_WEB_STYLESHEET = ".note { all: initial; display: flex; flex-direction: column; height: 150px; width: 150px; position: absolute; top: 10px; left: 10px; border: 1px solid rgb(191, 191, 191); z-index: 2147483646; box-shadow: 3px 3px 3px rgba(33, 33, 33, .7); min-height: 100px; min-width: 100px; } .note-selected { z-index: 2147483647; } .note-hidden { display: none; } .note-collapsed { min-height: 30px; max-height: 30px; overflow: hidden; } .note blockquote { all: initial; padding: 1px; height: 100%; } .note textarea { all: initial; white-space: break-spaces; font-family: Arial, Helvetica, sans-serif; font-size: 14px; height: 100%; width: 100%; padding: 2px; border: 1px solid transparent; resize: none; color: black; } .note textarea:focus { border: 1px dotted rgb(160, 160, 160); } .note header { all: initial; min-height: 30px; cursor: grab; user-select: none; } .note .note-remove { all: initial; position: absolute; right: 0px; top: 2px; padding: 5px; opacity: .5; cursor: pointer; user-select: none; width: 16px; height: 16px; } .note .note-anchor { all: initial; position: absolute; left: 0px; top: 2px; padding: 5px; opacity: .25; cursor: pointer; width: 16px; height: 16px; } .note .note-resize { all: initial; position: absolute; bottom: -5px; right: -5px; height: 15px; width: 15px; cursor: nwse-resize; user-select: none; } .note .note-remove:hover { opacity: 1; } .note .note-anchor:hover { opacity: .5; } .note-anchored .note-anchor { opacity: .5; } .note-anchored .note-anchor:hover { opacity: 1; } .note-moving { opacity: .75; box-shadow: 6px 6px 3px rgba(33, 33, 33, .7); } .note-moving * { cursor: grabbing; } .note-yellow header { background-color: #f5f545; } .note-yellow blockquote { background-color: #ffff7c; } .note-pink header { background-color: #ffa59f; } .note-pink blockquote { background-color: #ffbbb6; } .note-blue header { background-color: #84c8ff; } .note-blue blockquote { background-color: #95d0ff; } .note-green header { background-color: #93ef8d; } .note-green blockquote { background-color: #9cff95; }"; const MASK_WEB_STYLESHEET = ".note-mask { all: initial; position: fixed; z-index: 2147483645; pointer-events: none; background-color: transparent; transition: background-color 125ms; } .note-mask-moving.note-yellow { background-color: rgba(255, 255, 124, .3); } .note-mask-moving.note-pink { background-color: rgba(255, 187, 182, .3); } .note-mask-moving.note-blue { background-color: rgba(149, 208, 255, .3); } .note-mask-moving.note-green { background-color: rgba(156, 255, 149, .3); } .page-mask { all: initial; position: fixed; top: 0; left: 0; width: 0; height: 0; z-index: 2147483646; } .page-mask-active { width: 100vw; height: 100vh; }"; const NOTE_HEADER_HEIGHT = 25; const PAGE_MASK_ACTIVE_CLASS = "page-mask-active"; const REMOVED_CONTENT_CLASS = "single-file-removed"; const reflowNotes = function reflowNotes() { document.querySelectorAll(NOTE_TAGNAME).forEach(containerElement => { const noteElement = containerElement.shadowRoot.querySelector("." + NOTE_CLASS); const noteBoundingRect = noteElement.getBoundingClientRect(); const anchorElement = getAnchorElement(containerElement); const anchorBoundingRect = anchorElement.getBoundingClientRect(); const maxX = anchorBoundingRect.x + Math.max(0, anchorBoundingRect.width - noteBoundingRect.width); const minX = anchorBoundingRect.x; const maxY = anchorBoundingRect.y + Math.max(0, anchorBoundingRect.height - NOTE_HEADER_HEIGHT); const minY = anchorBoundingRect.y; let left = parseInt(noteElement.style.getPropertyValue("left")); let top = parseInt(noteElement.style.getPropertyValue("top")); if (noteBoundingRect.x > maxX) { left -= noteBoundingRect.x - maxX; } if (noteBoundingRect.x < minX) { left += minX - noteBoundingRect.x; } if (noteBoundingRect.y > maxY) { top -= noteBoundingRect.y - maxY; } if (noteBoundingRect.y < minY) { top += minY - noteBoundingRect.y; } noteElement.style.setProperty("position", "absolute"); noteElement.style.setProperty("left", left + "px"); noteElement.style.setProperty("top", top + "px"); }); }; const addNoteRef = function addNoteRef(anchorElement, noteId) { const noteRefs = getNoteRefs(anchorElement); noteRefs.push(noteId); setNoteRefs(anchorElement, noteRefs); }; const deleteNoteRef = function deleteNoteRef(containerElement, noteId) { const anchorElement = getAnchorElement(containerElement); const noteRefs = getNoteRefs(anchorElement).filter(noteRefs => noteRefs != noteId); if (noteRefs.length) { setNoteRefs(anchorElement, noteRefs); } else { delete anchorElement.dataset.singleFileNoteRefs; } }; const getNoteRefs = function getNoteRefs(anchorElement) { return anchorElement.dataset.singleFileNoteRefs ? anchorElement.dataset.singleFileNoteRefs.split(" ") : []; }; const setNoteRefs = function setNoteRefs(anchorElement, noteRefs) { anchorElement.dataset.singleFileNoteRefs = noteRefs.join(" "); }; const getAnchorElement = function getAnchorElement(containerElement) { return document.querySelector("[data-single-file-note-refs~=\"" + containerElement.dataset.noteId + "\"]") || document.documentElement; }; const getMaskElement = function getMaskElement(className, containerClassName) { let maskElement = document.documentElement.querySelector("." + className); if (!maskElement) { maskElement = document.createElement("div"); const maskContainerElement = document.createElement("div"); if (containerClassName) { maskContainerElement.classList.add(containerClassName); } maskContainerElement.classList.add(MASK_CLASS); const firstNote = document.querySelector(NOTE_TAGNAME); if (firstNote && firstNote.parentElement == document.documentElement) { document.documentElement.insertBefore(maskContainerElement, firstNote); } else { document.documentElement.appendChild(maskContainerElement); } maskElement.classList.add(className); const maskShadow = maskContainerElement.attachShadow({ mode: "open" }); maskShadow.appendChild(getStyleElement(MASK_WEB_STYLESHEET)); maskShadow.appendChild(maskElement); return maskElement; } }; const getStyleElement = function getStyleElement(stylesheet) { const linkElement = document.createElement("style"); linkElement.textContent = stylesheet; return linkElement; }; const attachNoteListeners = function attachNoteListeners(containerElement, editable = false) { const SELECT_PX_THRESHOLD = 4; const COLLAPSING_NOTE_DELAY = 750; const noteShadow = containerElement.shadowRoot; const noteElement = noteShadow.childNodes[1]; const headerElement = noteShadow.querySelector("header"); const mainElement = noteShadow.querySelector("textarea"); const noteId = containerElement.dataset.noteId; const resizeElement = noteShadow.querySelector(".note-resize"); const anchorIconElement = noteShadow.querySelector(".note-anchor"); const removeNoteElement = noteShadow.querySelector(".note-remove"); mainElement.readOnly = !editable; if (!editable) { anchorIconElement.style.setProperty("display", "none", "important"); } else { anchorIconElement.style.removeProperty("display"); } headerElement.ontouchstart = headerElement.onmousedown = event => { if (event.target == headerElement) { collapseNoteTimeout = setTimeout(() => { noteElement.classList.toggle("note-collapsed"); hideMaskNote(); }, COLLAPSING_NOTE_DELAY); event.preventDefault(); const position = getPosition(event); const clientX = position.clientX; const clientY = position.clientY; const boundingRect = noteElement.getBoundingClientRect(); const deltaX = clientX - boundingRect.left; const deltaY = clientY - boundingRect.top; maskPageElement.classList.add(PAGE_MASK_ACTIVE_CLASS); document.documentElement.style.setProperty("user-select", "none", "important"); anchorElement = getAnchorElement(containerElement); displayMaskNote(); selectNote(noteElement); moveNote(event, deltaX, deltaY); movingNoteMode = { event, deltaX, deltaY }; document.documentElement.ontouchmove = document.documentElement.onmousemove = event => { clearTimeout(collapseNoteTimeout); if (!movingNoteMode) { movingNoteMode = { deltaX, deltaY }; } movingNoteMode.event = event; moveNote(event, deltaX, deltaY); }; } }; resizeElement.ontouchstart = resizeElement.onmousedown = event => { event.preventDefault(); resizingNoteMode = true; selectNote(noteElement); maskPageElement.classList.add(PAGE_MASK_ACTIVE_CLASS); document.documentElement.style.setProperty("user-select", "none", "important"); document.documentElement.ontouchmove = document.documentElement.onmousemove = event => { event.preventDefault(); const { clientX, clientY } = getPosition(event); const boundingRectNote = noteElement.getBoundingClientRect(); noteElement.style.width = clientX - boundingRectNote.left + "px"; noteElement.style.height = clientY - boundingRectNote.top + "px"; }; }; anchorIconElement.ontouchend = anchorIconElement.onclick = event => { event.preventDefault(); noteElement.classList.toggle(NOTE_ANCHORED_CLASS); if (!noteElement.classList.contains(NOTE_ANCHORED_CLASS)) { deleteNoteRef(containerElement, noteId); addNoteRef(document.documentElement, noteId); } onUpdate(false); }; removeNoteElement.ontouchend = removeNoteElement.onclick = event => { event.preventDefault(); deleteNoteRef(containerElement, noteId); containerElement.remove(); }; noteElement.onmousedown = () => { selectNote(noteElement); }; function moveNote(event, deltaX, deltaY) { event.preventDefault(); const { clientX, clientY } = getPosition(event); noteElement.classList.add(NOTE_MOVING_CLASS); if (editable) { if (noteElement.classList.contains(NOTE_ANCHORED_CLASS)) { deleteNoteRef(containerElement, noteId); anchorElement = getTarget(clientX, clientY) || document.documentElement; addNoteRef(anchorElement, noteId); } else { anchorElement = document.documentElement; } } document.documentElement.insertBefore(containerElement, maskPageElement.getRootNode().host); noteElement.style.setProperty("left", (clientX - deltaX) + "px"); noteElement.style.setProperty("top", (clientY - deltaY) + "px"); noteElement.style.setProperty("position", "fixed"); displayMaskNote(); } function displayMaskNote() { if (anchorElement == document.documentElement || anchorElement == document.documentElement) { hideMaskNote(); } else { const boundingRectAnchor = anchorElement.getBoundingClientRect(); maskNoteElement.classList.add(NOTE_MASK_MOVING_CLASS); if (selectedNote) { maskNoteElement.classList.add(selectedNote.dataset.color); } maskNoteElement.style.setProperty("top", (boundingRectAnchor.y - 3) + "px"); maskNoteElement.style.setProperty("left", (boundingRectAnchor.x - 3) + "px"); maskNoteElement.style.setProperty("width", (boundingRectAnchor.width + 3) + "px"); maskNoteElement.style.setProperty("height", (boundingRectAnchor.height + 3) + "px"); } } function hideMaskNote() { maskNoteElement.classList.remove(NOTE_MASK_MOVING_CLASS); if (selectedNote) { maskNoteElement.classList.remove(selectedNote.dataset.color); } } function selectNote(noteElement) { if (selectedNote) { selectedNote.classList.remove(NOTE_SELECTED_CLASS); maskNoteElement.classList.remove(selectedNote.dataset.color); } noteElement.classList.add(NOTE_SELECTED_CLASS); noteElement.classList.add(noteElement.dataset.color); selectedNote = noteElement; } function getTarget(clientX, clientY) { const targets = Array.from(document.elementsFromPoint(clientX, clientY)).filter(element => element.matches("html *:not(" + NOTE_TAGNAME + "):not(." + MASK_CLASS + ")")); if (!targets.includes(document.documentElement)) { targets.push(document.documentElement); } let newTarget, target = targets[0], boundingRect = target.getBoundingClientRect(); newTarget = determineTargetElement("floor", target, clientX - boundingRect.left, getMatchedParents(target, "left")); if (newTarget == target) { newTarget = determineTargetElement("ceil", target, boundingRect.left + boundingRect.width - clientX, getMatchedParents(target, "right")); } if (newTarget == target) { newTarget = determineTargetElement("floor", target, clientY - boundingRect.top, getMatchedParents(target, "top")); } if (newTarget == target) { newTarget = determineTargetElement("ceil", target, boundingRect.top + boundingRect.height - clientY, getMatchedParents(target, "bottom")); } target = newTarget; while (boundingRect = target && target.getBoundingClientRect(), boundingRect && boundingRect.width <= SELECT_PX_THRESHOLD && boundingRect.height <= SELECT_PX_THRESHOLD) { target = target.parentElement; } return target; } function getMatchedParents(target, property) { let element = target, matchedParent, parents = []; do { const boundingRect = element.getBoundingClientRect(); if (element.parentElement && !element.parentElement.tagName.toLowerCase() != NOTE_TAGNAME && !element.classList.contains(MASK_CLASS)) { const parentBoundingRect = element.parentElement.getBoundingClientRect(); matchedParent = Math.abs(parentBoundingRect[property] - boundingRect[property]) <= SELECT_PX_THRESHOLD; if (matchedParent) { if (element.parentElement.clientWidth > SELECT_PX_THRESHOLD && element.parentElement.clientHeight > SELECT_PX_THRESHOLD && ((element.parentElement.clientWidth - element.clientWidth > SELECT_PX_THRESHOLD) || (element.parentElement.clientHeight - element.clientHeight > SELECT_PX_THRESHOLD))) { parents.push(element.parentElement); } element = element.parentElement; } } else { matchedParent = false; } } while (matchedParent && element); return parents; } function determineTargetElement(roundingMethod, target, widthDistance, parents) { if (Math[roundingMethod](widthDistance / SELECT_PX_THRESHOLD) <= parents.length) { target = parents[parents.length - Math[roundingMethod](widthDistance / SELECT_PX_THRESHOLD) - 1]; } return target; } }; const anchorNote = function anchorNote(event, noteElement, deltaX, deltaY) { event.preventDefault(); const { clientX, clientY } = getPosition(event); document.documentElement.style.removeProperty("user-select"); noteElement.classList.remove(NOTE_MOVING_CLASS); maskNoteElement.classList.remove(NOTE_MASK_MOVING_CLASS); maskPageElement.classList.remove(PAGE_MASK_ACTIVE_CLASS); maskNoteElement.classList.remove(noteElement.dataset.color); const headerElement = noteElement.querySelector("header"); headerElement.ontouchmove = document.documentElement.onmousemove = null; let currentElement = anchorElement; let positionedElement; while (currentElement.parentElement && !positionedElement) { if (!FORBIDDEN_TAG_NAMES.includes(currentElement.tagName.toLowerCase())) { const currentElementStyle = getComputedStyle(currentElement); if (currentElementStyle.position != "static") { positionedElement = currentElement; } } currentElement = currentElement.parentElement; } if (!positionedElement) { positionedElement = document.documentElement; } const containerElement = noteElement.getRootNode().host; if (positionedElement == document.documentElement) { const firstMaskElement = document.querySelector("." + MASK_CLASS); firstMaskElement.parentElement.insertBefore(containerElement, firstMaskElement); } else { positionedElement.appendChild(containerElement); } const boundingRectPositionedElement = positionedElement.getBoundingClientRect(); const stylePositionedElement = window.getComputedStyle(positionedElement); const borderX = parseInt(stylePositionedElement.getPropertyValue("border-left-width")); const borderY = parseInt(stylePositionedElement.getPropertyValue("border-top-width")); noteElement.style.setProperty("position", "absolute"); noteElement.style.setProperty("left", (clientX - boundingRectPositionedElement.x - deltaX - borderX) + "px"); noteElement.style.setProperty("top", (clientY - boundingRectPositionedElement.y - deltaY - borderY) + "px"); }; const getPosition = function getPosition(event) { if (event.touches && event.touches.length) { const touch = event.touches[0]; return touch; } else { return event; } }; const onMouseUp = function onMouseUp(event) { if (highlightSelectionMode) { event.preventDefault(); highlightSelection(); onUpdate(false); } if (removeHighlightMode) { event.preventDefault(); let element = event.target, done; while (element && !done) { if (element.classList.contains(HIGHLIGHT_CLASS)) { document.querySelectorAll("." + HIGHLIGHT_CLASS + "[data-singlefile-highlight-id=" + JSON.stringify(element.dataset.singlefileHighlightId) + "]").forEach(highlightedElement => { resetHighlightedElement(highlightedElement); onUpdate(false); }); done = true; } element = element.parentElement; } } if (resizingNoteMode) { event.preventDefault(); resizingNoteMode = false; document.documentElement.style.removeProperty("user-select"); maskPageElement.classList.remove(PAGE_MASK_ACTIVE_CLASS); document.documentElement.ontouchmove = onTouchMove; document.documentElement.onmousemove = null; onUpdate(false); } if (movingNoteMode) { event.preventDefault(); anchorNote(movingNoteMode.event || event, selectedNote, movingNoteMode.deltaX, movingNoteMode.deltaY); movingNoteMode = null; document.documentElement.ontouchmove = onTouchMove; document.documentElement.onmousemove = null; onUpdate(false); } if ((cuttingMode || cuttingOuterMode) && cuttingPath) { event.preventDefault(); if (event.ctrlKey) { const element = cuttingPath[cuttingPathIndex]; element.classList.toggle(cuttingMode ? CUT_SELECTED_CLASS : CUT_OUTER_SELECTED_CLASS); } else { validateCutElement(event.shiftKey); } } if (collapseNoteTimeout) { clearTimeout(collapseNoteTimeout); collapseNoteTimeout = null; } }; const getShadowRoot = function getShadowRoot(element) { const chrome = window.chrome; if (element.openOrClosedShadowRoot) { return element.openOrClosedShadowRoot; } else if (chrome && chrome.dom && chrome.dom.openOrClosedShadowRoot) { try { return chrome.dom.openOrClosedShadowRoot(element); } catch (error) { return element.shadowRoot; } } else { return element.shadowRoot; } }; const maskNoteElement = getMaskElement("note-mask"); const maskPageElement = getMaskElement("page-mask", "single-file-page-mask"); let selectedNote, highlightSelectionMode, removeHighlightMode, resizingNoteMode, movingNoteMode, collapseNoteTimeout, cuttingMode, cuttingOuterMode; window.onresize = reflowNotes; window.onUpdate = () => {}; document.documentElement.onmouseup = document.documentElement.ontouchend = onMouseUp; processNode(document); reflowNotes(); document.querySelectorAll("single-file-note").forEach(noteElement => attachNoteListeners(noteElement)); })()</script>